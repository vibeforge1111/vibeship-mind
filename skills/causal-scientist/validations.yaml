# Causal Scientist Validations
# Automated checks for causal inference patterns

validations:
  - id: dowhy-proceed-unidentifiable
    name: DoWhy Proceeding When Unidentifiable
    severity: error
    type: regex
    pattern:
      - 'proceed_when_unidentifiable.*=.*True'
      - 'proceed_when_unidentifiable=True'
    message: "DoWhy proceeding when effect is unidentifiable. Estimate is meaningless."
    fix_action: "Set proceed_when_unidentifiable=False and handle unidentifiable cases"
    applies_to:
      - "**/causal/**/*.py"
      - "**/*causal*.py"

  - id: causal-no-refutation
    name: Causal Estimate Without Refutation
    severity: error
    type: regex
    pattern:
      - 'estimate_effect\\([^)]*\\)(?!.*refute)'
      - 'model\\.estimate(?!.*refut)'
    message: "Causal estimate without refutation tests. Effect may not be robust."
    fix_action: "Add refutation tests: random_common_cause, placebo, data_subset"
    applies_to:
      - "**/causal/**/*.py"

  - id: causal-single-estimator
    name: Using Only Single Causal Estimator
    severity: warning
    type: regex
    pattern:
      - 'method_name.*=.*["\']backdoor\\.'
      - 'estimate_effect.*method.*=(?!.*multiple|.*robust)'
    message: "Using single causal estimator. Use multiple for robustness."
    fix_action: "Try multiple estimators and check agreement"
    applies_to:
      - "**/causal/**/*.py"

  - id: causal-graph-no-validation
    name: Causal Graph Without Cycle Check
    severity: error
    type: regex
    pattern:
      - 'DiGraph\\(\\)(?!.*is_directed_acyclic|.*simple_cycles)'
      - 'add_edge(?!.*validate|.*acyclic)'
    message: "Building causal graph without validating DAG properties."
    fix_action: "Validate graph is acyclic with nx.is_directed_acyclic_graph()"
    applies_to:
      - "**/causal/**/*.py"
      - "**/graph/**/*.py"

  - id: causal-discovery-no-sample-check
    name: Causal Discovery Without Sample Size Check
    severity: warning
    type: regex
    pattern:
      - 'pc\\((?!.*len.*>|.*sample)'
      - 'fci\\((?!.*size|.*sample)'
    message: "Causal discovery without checking sample size. May lack power."
    fix_action: "Verify sufficient samples per variable (~50-100)"
    applies_to:
      - "**/causal/**/*.py"

  - id: counterfactual-no-uncertainty
    name: Counterfactual Without Uncertainty
    severity: warning
    type: regex
    pattern:
      - 'counterfactual.*\\.mean\\(\\)(?!.*std|.*percentile)'
      - 'counterfactual(?!.*confidence|.*interval|.*std)'
    message: "Counterfactual without uncertainty quantification."
    fix_action: "Report confidence intervals for counterfactual estimates"
    applies_to:
      - "**/causal/**/*.py"

  - id: causal-no-confounders
    name: Causal Model Without Confounders
    severity: warning
    type: regex
    pattern:
      - 'CausalModel\\([^)]*treatment[^)]*outcome[^)]*\\)(?!.*common_causes)'
      - 'common_causes.*=.*\\[\\]'
      - 'common_causes.*=.*None'
    message: "Causal model without confounders specified. Effect likely biased."
    fix_action: "Identify and specify common causes (confounders)"
    applies_to:
      - "**/causal/**/*.py"

  - id: causal-correlation-claim
    name: Causal Claim From Correlation
    severity: error
    type: regex
    pattern:
      - 'corr.*caus|caus.*corr'
      - '\\.corr\\(\\).*effect'
      - 'correlation.*implies.*causation'
    message: "Correlation used to claim causation. Need proper causal inference."
    fix_action: "Use DoWhy or similar for proper causal effect estimation"
    applies_to:
      - "**/*.py"

  - id: causal-effect-no-ci
    name: Causal Effect Without Confidence Interval
    severity: info
    type: regex
    pattern:
      - 'estimate\\.value(?!.*confidence|.*interval)'
      - 'effect.*=.*estimate(?!.*ci|.*interval)'
    message: "Causal effect reported without confidence interval."
    fix_action: "Use estimate.get_confidence_intervals()"
    applies_to:
      - "**/causal/**/*.py"

  - id: causal-temporal-order-ignored
    name: Causal Graph Without Temporal Ordering
    severity: info
    type: regex
    pattern:
      - 'add_edge(?!.*temporal|.*time|.*order)'
      - 'CausalModel(?!.*temporal)'
    message: "Causal graph built without temporal ordering constraints."
    fix_action: "Apply temporal ordering: causes must precede effects"
    applies_to:
      - "**/causal/**/*.py"

  - id: intervention-extrapolation
    name: Intervention Outside Observed Range
    severity: warning
    type: regex
    pattern:
      - 'intervention.*=(?!.*min|.*max|.*range)'
      - 'do\\((?!.*bounds|.*range)'
    message: "Intervention may be outside observed data range."
    fix_action: "Check if intervention value is within training data range"
    applies_to:
      - "**/causal/**/*.py"

  - id: ate-not-individual
    name: Using ATE for Individual Predictions
    severity: warning
    type: regex
    pattern:
      - 'average.*treatment.*effect.*individual'
      - 'ate.*predict.*user'
    message: "Average treatment effect used for individual predictions."
    fix_action: "Consider CATE (Conditional Average Treatment Effect) for heterogeneous effects"
    applies_to:
      - "**/causal/**/*.py"

  # Mind v5 Specific Validations
  - id: mind-v5-causal-edge-missing-confidence
    name: Causal Edge Without Confidence Score
    severity: error
    type: regex
    pattern:
      - 'CREATE.*CAUSES.*{(?![\\s\\S]*confidence)'
      - 'store_causal.*(?!.*confidence)'
    message: "Mind v5 causal edges must include confidence score."
    fix_action: "Add confidence score from DoWhy CI width and refutation"
    applies_to:
      - "src/core/causal/*.py"
      - "src/infrastructure/falkordb/*.py"

  - id: mind-v5-causal-edge-missing-evidence
    name: Causal Edge Without Evidence Count
    severity: error
    type: regex
    pattern:
      - 'CREATE.*CAUSES.*{(?![\\s\\S]*evidence_count)'
    message: "Mind v5 causal edges must track evidence count."
    fix_action: "Add evidence_count from estimate.n_observations"
    applies_to:
      - "src/core/causal/*.py"
      - "src/infrastructure/falkordb/*.py"

  - id: mind-v5-attribution-no-decision-trace
    name: Causal Attribution Without Decision Trace
    severity: error
    type: regex
    pattern:
      - 'async def.*attribut[\\s\\S]*?(?!.*DecisionTrace|.*trace:)'
    message: "Mind v5 attribution requires DecisionTrace for memory usage context."
    fix_action: "Pass DecisionTrace with memories_used and memory_influence"
    applies_to:
      - "src/core/causal/attribution.py"
      - "**/causal/*.py"

  - id: mind-v5-discovery-no-temporal-order
    name: Causal Discovery Without Temporal Constraints
    severity: warning
    type: regex
    pattern:
      - 'pc\\(|fci\\((?!.*temporal|.*time_order)'
    message: "Mind v5 causal discovery should use temporal ordering constraints."
    fix_action: "Apply temporal_order constraints based on created_at/observed_at"
    applies_to:
      - "src/core/causal/discovery.py"
      - "**/causal/*.py"

  - id: mind-v5-causal-no-refutation-store
    name: Storing Causal Edge Without Refutation Status
    severity: warning
    type: regex
    pattern:
      - 'CAUSES.*{(?![\\s\\S]*refutation)'
    message: "Mind v5 should track whether causal edge passed refutation tests."
    fix_action: "Add refutation_passed: bool from DoWhy refutation"
    applies_to:
      - "src/core/causal/*.py"
