# Test Architect Validations
# Automated checks for testing patterns

validations:
  - id: missing-assertion
    name: Test Without Assertion
    severity: error
    type: regex
    pattern:
      - 'def test_[^(]+\([^)]*\):[^}]+(?<!assert)$'
      - 'it\(["\'][^"\']+["\'],\s*\(\)\s*=>\s*\{[^}]+\}\)(?!.*expect)'
    message: "Test function without assertion. Test always passes."
    fix_action: "Add assert or expect statement to verify behavior"
    applies_to:
      - "**/test_*.py"
      - "**/*.test.ts"
      - "**/*.spec.ts"

  - id: hardcoded-test-data
    name: Hardcoded Email/ID in Tests
    severity: info
    type: regex
    pattern:
      - 'test@example\.com'
      - 'user_123'
      - 'agent_test'
    message: "Hardcoded test data may cause isolation issues."
    fix_action: "Use unique generated data: f'test_{uuid4().hex}@example.com'"
    applies_to:
      - "**/test_*.py"
      - "**/*.test.ts"
      - "**/*.spec.ts"

  - id: sleep-in-test
    name: Fixed Sleep in Async Test
    severity: warning
    type: regex
    pattern:
      - 'asyncio\.sleep\([0-9]'
      - 'time\.sleep\([0-9]'
      - 'await.*delay\([0-9]'
      - 'setTimeout.*[0-9]+\)'
    message: "Fixed sleep causes flaky tests. Use condition-based waiting."
    fix_action: "Use await wait_for(condition) or polling with timeout"
    applies_to:
      - "**/test_*.py"
      - "**/*.test.ts"
      - "**/*.spec.ts"

  - id: async-not-awaited
    name: Async Call Not Awaited in Test
    severity: error
    type: regex
    pattern:
      - 'assert\s+\w+\(\)(?!.*await)'
      - 'expect\(\w+\(\)\)\.to'
    message: "Async call may not be awaited. Test may pass falsely."
    fix_action: "Add await: assert await function() or await expect()"
    applies_to:
      - "**/test_*.py"
      - "**/*.test.ts"

  - id: mock-overuse
    name: Excessive Mocking
    severity: info
    type: regex
    pattern:
      - '@mock\.patch.*@mock\.patch.*@mock\.patch'
      - 'jest\.mock.*jest\.mock.*jest\.mock'
      - 'Mock\(\).*Mock\(\).*Mock\(\)'
    message: "Multiple mocks may hide integration issues."
    fix_action: "Consider using fakes or integration tests for complex interactions"
    applies_to:
      - "**/test_*.py"
      - "**/*.test.ts"

  - id: test-not-async
    name: Async Function Test Missing Async
    severity: error
    type: regex
    pattern:
      - 'def test_.*await'
      - 'function test.*await(?!.*async)'
    message: "Test uses await but function is not async."
    fix_action: "Add async to function definition: async def test_..."
    applies_to:
      - "**/test_*.py"
      - "**/*.test.ts"

  - id: no-fixture-cleanup
    name: Fixture Without Cleanup
    severity: warning
    type: regex
    pattern:
      - '@pytest\.fixture(?!.*yield|.*return)'
      - 'beforeEach(?!.*afterEach)'
    message: "Fixture creates resources but may not clean up."
    fix_action: "Use yield and cleanup after: yield resource; cleanup()"
    applies_to:
      - "**/test_*.py"
      - "**/conftest.py"
      - "**/*.test.ts"

  - id: snapshot-without-filter
    name: Snapshot Test Without Filtering
    severity: info
    type: regex
    pattern:
      - 'assert_match\([^)]+\)(?!.*exclude)'
      - 'toMatchSnapshot\(\)(?!.*omit)'
    message: "Snapshot includes all fields. May break on irrelevant changes."
    fix_action: "Filter out timestamps, IDs: assert_match(data, exclude=['created_at'])"
    applies_to:
      - "**/test_*.py"
      - "**/*.test.ts"

  - id: test-order-dependency
    name: Test Depends on Other Test
    severity: error
    type: regex
    pattern:
      - 'test_[a-z]+.*test_[a-z]+'
      - '@pytest\.mark\.order'
      - 'jest\..*runInBand'
    message: "Tests may depend on execution order. Should be independent."
    fix_action: "Use fixtures for setup, each test should be self-contained"
    applies_to:
      - "**/test_*.py"
      - "**/*.test.ts"

  - id: missing-error-test
    name: No Error Case Test
    severity: info
    type: regex
    pattern:
      - 'class Test\w+:(?!.*error|.*exception|.*fail|.*invalid)'
      - 'describe\([^)]+\)(?!.*error|.*throw|.*reject)'
    message: "Test class has no error/exception tests."
    fix_action: "Add tests for error cases: test_raises_on_invalid_input"
    applies_to:
      - "**/test_*.py"
      - "**/*.test.ts"

  - id: flaky-test-retry
    name: Test Marked as Flaky/Retry
    severity: warning
    type: regex
    pattern:
      - '@pytest\.mark\.flaky'
      - '@retry'
      - 'jest\.retryTimes'
    message: "Test marked as flaky. Should be fixed or removed."
    fix_action: "Fix underlying timing/isolation issue instead of retrying"
    applies_to:
      - "**/test_*.py"
      - "**/*.test.ts"

  - id: large-test-file
    name: Test File Too Large
    severity: info
    type: regex
    pattern:
      - 'def test_.*def test_.*def test_.*def test_.*def test_.*def test_.*def test_.*def test_.*def test_.*def test_'
    message: "Test file has many tests. Consider splitting by feature."
    fix_action: "Split into focused test files: test_create.py, test_update.py"
    applies_to:
      - "**/test_*.py"
      - "**/*.test.ts"

  # Mind v5 Specific Validations
  - id: mind-v5-missing-decision-trace-test
    name: Decision Code Without Trace Tests
    severity: error
    type: regex
    pattern:
      - 'src/core/decision/.*\\.py(?!.*test.*trace|.*test.*attribution)'
    message: "Mind v5 decision code requires tests for outcome attribution."
    fix_action: "Add test_decision_trace_captures_memories, test_outcome_updates_salience"
    applies_to:
      - "tests/unit/core/decision/**/*.py"
      - "tests/integration/decision/**/*.py"

  - id: mind-v5-missing-causal-refutation-test
    name: Causal Inference Without Refutation Tests
    severity: error
    type: regex
    pattern:
      - 'test.*causal(?!.*refut)'
      - 'class TestCausal(?![\s\S]*refut)'
    message: "Mind v5 causal tests must include refutation test cases."
    fix_action: "Add test_random_common_cause_refutation, test_placebo_refutation"
    applies_to:
      - "tests/**/test_*causal*.py"

  - id: mind-v5-missing-federation-privacy-test
    name: Federation Code Without Privacy Tests
    severity: error
    type: regex
    pattern:
      - 'src/core/federation/.*\\.py(?!.*test.*privacy|.*test.*pii)'
    message: "Mind v5 federation requires privacy leakage tests."
    fix_action: "Add test_no_pii_in_federated_patterns, test_differential_privacy_epsilon"
    applies_to:
      - "tests/**/test_*federation*.py"

  - id: mind-v5-missing-memory-isolation-test
    name: Memory Retrieval Without Isolation Tests
    severity: warning
    type: regex
    pattern:
      - 'class TestMemory(?![\s\S]*isolation|.*user.*cannot.*access)'
    message: "Mind v5 memory tests should verify user isolation."
    fix_action: "Add test_user_cannot_access_other_user_memories"
    applies_to:
      - "tests/**/test_*memory*.py"
      - "tests/**/test_*retrieval*.py"
